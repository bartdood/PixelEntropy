<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SF Virtual Tour</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core/index.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/markers-plugin/index.min.css" />

  <style>
    body { margin: 0; background: #000; font-family: sans-serif; }
    #viewer { width: 100vw; height: 100vh; }
  </style>
</head>
<body>

<div id="viewer"></div>

<script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three/build/three.module.js",
      "@photo-sphere-viewer/core": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core/index.module.js",
      "@photo-sphere-viewer/markers-plugin": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/markers-plugin/index.module.js"
    }
  }
</script>

<script type="module">
  // Import the specific parts we need
  import { Viewer } from '@photo-sphere-viewer/core';
  import { MarkersPlugin } from '@photo-sphere-viewer/markers-plugin';

  const viewer = new Viewer({
    container: document.querySelector('#viewer'),
    panorama: 'scenes/bart-sf.jpg', 
    plugins: [
      [MarkersPlugin, {}]
    ],
  });

  const markers = viewer.getPlugin(MarkersPlugin);

  // Define Marker Style
  const redMarkerStyle = {
    fill: 'rgba(200, 0, 0, 0.8)',
    stroke: 'white',
    strokeWidth: '2px',
  };

  // We expose this function to the window so we can call it recursively if needed,
  // but inside modules, functions are private by default.
  // We'll write the logic to handle clicks purely via events below.
  
  function getMarkersForScene(sceneName) {
    const newMarkers = [];

    // BART -> Ferry
    if (sceneName === 'bart-sf.jpg') {
      newMarkers.push({
        id: 'to-ferry',
        circle: 20,
        circleStyle: redMarkerStyle,
        yaw: 1.0, pitch: -0.1,
        tooltip: 'Go to Ferry',
        data: { target: 'ferry-sf.jpg' }
      });
    }

    // Ferry -> Bay Bridge
    if (sceneName === 'ferry-sf.jpg') {
      newMarkers.push({
        id: 'to-bridge',
        circle: 20,
        circleStyle: redMarkerStyle,
        yaw: -2.2, pitch: -0.1,
        tooltip: 'Go to Bay Bridge',
        data: { target: 'bay-bridge-sf.jpg' }
      });
    }

    // Bay Bridge -> BART
    if (sceneName === 'bay-bridge-sf.jpg') {
      newMarkers.push({
        id: 'to-bart',
        circle: 20,
        circleStyle: redMarkerStyle,
        yaw: 2.8, pitch: -0.1,
        tooltip: 'Back to BART',
        data: { target: 'bart-sf.jpg' }
      });
    }
    return newMarkers;
  }

  // Initial Load Logic
  const initialScene = 'bart-sf.jpg';
  const initialMarkers = getMarkersForScene(initialScene);
  initialMarkers.forEach(m => markers.addMarker(m));

  // Handle Marker Clicks
  markers.addEventListener('select-marker', ({ marker }) => {
    if (marker.data && marker.data.target) {
      const nextScene = marker.data.target;
      
      // Change Scene
      viewer.setPanorama('scenes/' + nextScene).then(() => {
        // Clear and Add New Markers
        markers.clearMarkers();
        const nextMarkers = getMarkersForScene(nextScene);
        nextMarkers.forEach(m => markers.addMarker(m));
      }).catch(err => {
        console.error("Error changing scene:", err);
        alert("Could not load: " + nextScene);
      });
    }
  });

</script>
</body>
</html>
