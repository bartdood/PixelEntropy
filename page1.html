<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SF Virtual Tour</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core/index.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/markers-plugin/index.min.css" />

  <style>
    body { margin: 0; background: #000; font-family: sans-serif; }
    #viewer { width: 100vw; height: 100vh; }
    
    /* Loading overlay */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #loading-overlay.active {
      display: flex;
    }
    .loading-spinner {
      border: 8px solid #333;
      border-top: 8px solid #00ff00;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

<div id="viewer"></div>
<div id="loading-overlay">
  <div class="loading-spinner"></div>
</div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three/build/three.module.js",
    "@photo-sphere-viewer/core": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core/index.module.js",
    "@photo-sphere-viewer/markers-plugin": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/markers-plugin/index.module.js"
  }
}
</script>

<script type="module">
  import { Viewer } from '@photo-sphere-viewer/core';
  import { MarkersPlugin } from '@photo-sphere-viewer/markers-plugin';

  let viewer;
  let markers;

  try {
    viewer = new Viewer({
      container: document.querySelector('#viewer'),
      panorama: 'scenes/bart-sf.jpg', 
      plugins: [
        [MarkersPlugin, {}]
      ],
      loadingImg: null,
      navbar: false,
    });

    markers = viewer.getPlugin(MarkersPlugin);
  } catch (err) {
    console.error('Error initializing viewer:', err);
    alert('Error initializing the virtual tour. Please check that all panorama images are in the scenes/ folder.');
  }

  // =========================================================
  //  SMALL GREEN CIRCLE MARKER STYLE
  // =========================================================
  function createLabel(text) {
    return `
      <div style="
        cursor: pointer;
        width: 40px;
        height: 40px;
        background: #00ff00;
        border: 3px solid white;
        border-radius: 50%;
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
      " title="${text}">
      </div>
    `;
  }

  function getMarkersForScene(sceneName) {
    const newMarkers = [];

    // Scene 1: BART
    if (sceneName === 'bart-sf.jpg') {
      newMarkers.push({
        id: 'to-ferry',
        html: createLabel('➡ Go to Ferry'),
        position: { yaw: 0.5, pitch: -0.1 },
        data: { target: 'ferry-sf.jpg' }
      });
    }

    // Scene 2: Ferry
    if (sceneName === 'ferry-sf.jpg') {
      newMarkers.push({
        id: 'to-bridge',
        html: createLabel('➡ Go to Bridge'),
        position: { yaw: -0.5, pitch: 0 },
        data: { target: 'bay-bridge-sf.jpg' }
      });
    }

    // Scene 3: Bridge
    if (sceneName === 'bay-bridge-sf.jpg') {
      newMarkers.push({
        id: 'to-bart',
        html: createLabel('⬅ Back to BART'),
        position: { yaw: 2.8, pitch: 0 },
        data: { target: 'bart-sf.jpg' }
      });
    }
    return newMarkers;
  }

  // --- Logic to Switch Scenes --- //

  if (viewer && markers) {
    const loadingOverlay = document.getElementById('loading-overlay');
    
    viewer.addEventListener('ready', () => {
      const startScene = 'bart-sf.jpg';
      const startMarkers = getMarkersForScene(startScene);
      startMarkers.forEach(m => markers.addMarker(m));
    }, { once: true });

    markers.addEventListener('select-marker', ({ marker }) => {
      if (marker.data && marker.data.target) {
        const nextScene = marker.data.target;
        
        // Show loading overlay
        loadingOverlay.classList.add('active');
        
        // Clear markers during transition
        markers.clearMarkers();
        
        viewer.setPanorama('scenes/' + nextScene).then(() => {
          const nextMarkers = getMarkersForScene(nextScene);
          nextMarkers.forEach(m => markers.addMarker(m));
          // Hide loading overlay
          loadingOverlay.classList.remove('active');
        }).catch(err => {
          console.error('Error loading scene:', err);
          loadingOverlay.classList.remove('active');
          alert("Error loading: scenes/" + nextScene + "\n\nPlease check that the image file exists.");
          // Try to restore previous scene markers if load fails
          const currentScene = viewer.config.panorama.split('/').pop();
          const currentMarkers = getMarkersForScene(currentScene);
          currentMarkers.forEach(m => markers.addMarker(m));
        });
      }
    });
  }

</script>
</body>
</html>
