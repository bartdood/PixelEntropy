<script type="module">
  import { Viewer } from '@photo-sphere-viewer/core';
  import { MarkersPlugin } from '@photo-sphere-viewer/markers-plugin';

  const viewer = new Viewer({
    container: document.querySelector('#viewer'),
    panorama: 'scenes/bart-sf.jpg', 
    plugins: [
      [MarkersPlugin, {}]
    ],
  });

  const markers = viewer.getPlugin(MarkersPlugin);

  // Debug Style: Bright Yellow with Text
  const debugMarkerStyle = {
    fill: 'yellow',
    stroke: 'black',
    strokeWidth: '2px',
  };

  function getMarkersForScene(sceneName) {
    console.log("Generating markers for:", sceneName); // DEBUG LOG
    const newMarkers = [];

    if (sceneName === 'bart-sf.jpg') {
      newMarkers.push({
        id: 'to-ferry',
        // REPLACED: Circle with explicit "content" (HTML text)
        // This creates a visible label instead of just a shape
        content: '<b style="color: yellow; font-size: 20px; background: black; padding: 5px;">âž¡ Go to Ferry</b>',
        yaw: 0.2, // Almost center
        pitch: 0, // Eye level
        tooltip: 'Go to Ferry',
        data: { target: 'ferry-sf.jpg' }
      });
    }

    if (sceneName === 'ferry-sf.jpg') {
      newMarkers.push({
        id: 'to-bridge',
        circle: 30, // Bigger circle
        circleStyle: debugMarkerStyle,
        yaw: -0.5, 
        pitch: 0,
        tooltip: 'Go to Bay Bridge',
        data: { target: 'bay-bridge-sf.jpg' }
      });
    }

    if (sceneName === 'bay-bridge-sf.jpg') {
      newMarkers.push({
        id: 'to-bart',
        circle: 30,
        circleStyle: debugMarkerStyle,
        yaw: 0, 
        pitch: 0,
        tooltip: 'Back to BART',
        data: { target: 'bart-sf.jpg' }
      });
    }
    return newMarkers;
  }

  // --- SAFETY CHECK: Wait for viewer to be ready ---
  viewer.addEventListener('ready', () => {
    console.log("Viewer ready. Adding initial markers...");
    const initialScene = 'bart-sf.jpg';
    const initialMarkers = getMarkersForScene(initialScene);
    
    initialMarkers.forEach(m => {
      console.log("Adding marker:", m.id);
      markers.addMarker(m);
    });
  }, { once: true });

  // Handle Clicks
  markers.addEventListener('select-marker', ({ marker }) => {
    console.log("Clicked marker:", marker.id);
    if (marker.data && marker.data.target) {
      const nextScene = marker.data.target;
      
      viewer.setPanorama('scenes/' + nextScene).then(() => {
        console.log("Scene loaded:", nextScene);
        markers.clearMarkers();
        const nextMarkers = getMarkersForScene(nextScene);
        nextMarkers.forEach(m => markers.addMarker(m));
      }).catch(err => {
        console.error("Error changing scene:", err);
        alert("Could not load: scenes/" + nextScene);
      });
    }
  });

</script>
